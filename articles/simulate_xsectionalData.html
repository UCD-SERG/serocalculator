<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Generate a simulated cross-sectional sample and estimate seroincidence • serocalculator</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Generate a simulated cross-sectional sample and estimate seroincidence">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">serocalculator</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/serocalculator.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/serocalculator.html">Introduction to serocalculator</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Methodology</h6></li>
    <li><a class="dropdown-item" href="../articles/methodology.html">Methodology</a></li>
    <li><a class="dropdown-item" href="../articles/simulate_xsectionalData.html">Generate a simulated cross-sectional sample and estimate seroincidence</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Examples</h6></li>
    <li><a class="dropdown-item" href="../articles/enteric_fever_example.html">Enteric Fever Seroincidence Vignette</a></li>
    <li><a class="dropdown-item" href="../articles/scrubTyphus_example.html">Scrub Typhus Seroincidence Vignette</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/UCD-SERG/serocalculator/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<link href="simulate_xsectionalData_files/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="simulate_xsectionalData_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="simulate_xsectionalData_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="simulate_xsectionalData_files/datatables-binding-0.33/datatables.js"></script><link href="simulate_xsectionalData_files/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="simulate_xsectionalData_files/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="simulate_xsectionalData_files/dt-core-1.13.6/js/jquery.dataTables.min.js"></script><link href="simulate_xsectionalData_files/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="simulate_xsectionalData_files/crosstalk-1.2.1/js/crosstalk.min.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Generate a simulated cross-sectional sample and estimate seroincidence</h1>
            <h3 data-toc-skip class="subtitle">Enteric Fever using HlyE
IgG and/or HlyE IgA</h3>
            
      
      <small class="dont-index">Source: <a href="https://github.com/UCD-SERG/serocalculator/blob/update-pkgdown-1.3.0/vignettes/articles/simulate_xsectionalData.Rmd" class="external-link"><code>vignettes/articles/simulate_xsectionalData.Rmd</code></a></small>
      <div class="d-none name"><code>simulate_xsectionalData.Rmd</code></div>
    </div>

    
    
<p>This vignette shows how to simulate a cross-sectional sample of
seroresponses for incident infections as a Poisson process with
frequency <code>lambda</code>. Responses are generated for the
antibodies given in the <code>antigen_isos</code> argument.</p>
<p>Age range of the simulated cross-sectional record is
<code>lifespan</code>.</p>
<p>The size of the sample is <code>nrep</code>.</p>
<p>Each individual is simulated separately, but different antibodies are
modelled jointly.</p>
<p>Longitudinal parameters are calculated for an age:
<code>age.fx</code> (fixed age). However, when <code>age.fx</code> is
set to NA then the age at infection is used.</p>
<p>The boolean <code>renew.params</code> determines whether each
infection uses a new set of longitudinal parameters, sampled at random
from the posterior predictive output of the longitudinal model. If set
to <code>FALSE</code>, a parameter set is chosen at birth and kept,
but:</p>
<ol style="list-style-type: decimal">
<li><p>the baseline antibody levels (<code>y0</code>) are updated with
the simulated level (just) prior to infection, and</p></li>
<li><p>when <code>is.na(age.fx)</code> then the selected parameter
sample is updated for the age when infection occurs.</p></li>
</ol>
<p>There is also a variable <code>n.mc</code>: when <code>n.mc==0</code>
then a random MC sample is chosen out of the posterior set (1:4000).
When <code>n.mc</code> is given a value in 1:4000 then the chosen number
is fixed and reused in any subsequent infection. This is for diagnostic
purposes.</p>
<div class="section level2">
<h2 id="simulate-a-single-dataset">Simulate a single dataset<a class="anchor" aria-label="anchor" href="#simulate-a-single-dataset"></a>
</h2>
<div class="section level3">
<h3 id="load-model-parameters">load model parameters<a class="anchor" aria-label="anchor" href="#load-model-parameters"></a>
</h3>
<p>Here we load in longitudinal parameters; these are modeled from all
SEES cases across all ages and countries:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/UCD-SERG/serocalculator" class="external-link">serocalculator</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Attaching core tidyverse packages</span> ──────────────────────── tidyverse 2.0.0 ──</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dplyr    </span> 1.1.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">readr    </span> 2.1.5</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">forcats  </span> 1.0.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">stringr  </span> 1.5.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">ggplot2  </span> 3.5.1     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tibble   </span> 3.2.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">lubridate</span> 1.9.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tidyr    </span> 1.3.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">purrr    </span> 1.0.2     </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Conflicts</span> ────────────────────────────────────────── tidyverse_conflicts() ──</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">filter()</span> masks <span style="color: #0000BB;">stats</span>::filter()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">lag()</span>    masks <span style="color: #0000BB;">stats</span>::lag()</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use the conflicted package (<span style="color: #0000BB; font-style: italic;">&lt;http://conflicted.r-lib.org/&gt;</span>) to force all conflicts to become errors</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eclarke/ggbeeswarm" class="external-link">ggbeeswarm</a></span><span class="op">)</span> <span class="co"># for plotting</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">dmcmc</span> <span class="op">&lt;-</span></span>
<span>  <span class="st">"https://osf.io/download/rtw5k"</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/load_curve_params.html">load_curve_params</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">iter</span> <span class="op">&lt;</span> <span class="fl">500</span><span class="op">)</span> <span class="co"># reduce number of mcmc samples for speed</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualize-antibody-decay-model">visualize antibody decay model<a class="anchor" aria-label="anchor" href="#visualize-antibody-decay-model"></a>
</h3>
<p>We can graph individual MCMC samples from the posterior distribution
of model parameters using a <code><a href="../reference/autoplot.curve_params.html">autoplot.curve_params()</a></code> method
for the <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot()</a></code> function:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dmcmc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span>n_curves <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>We can use a logarithmic scale for the x-axis if desired:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dmcmc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span>log_x <span class="op">=</span> <span class="cn">TRUE</span>, n_curves <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<p>We can graph the median, 10%, and 90% quantiles of the model using
the <code><a href="../reference/graph.curve.params.html">graph.curve.params()</a></code> function:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Specify the antibody-isotype responses to include in analyses</span></span>
<span><span class="va">antibodies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgA"</span>, <span class="st">"HlyE_IgG"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dmcmc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/graph.curve.params.html">graph.curve.params</a></span><span class="op">(</span>antigen_isos <span class="op">=</span> <span class="va">antibodies</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 47 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/graph-curve-params-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="simulate-cross-sectional-data">Simulate cross-sectional data<a class="anchor" aria-label="anchor" href="#simulate-cross-sectional-data"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set seed to reproduce results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">54321</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulated incidence rate per person-year</span></span>
<span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="co"># range covered in simulations</span></span>
<span><span class="va">lifespan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co"># cross-sectional sample size</span></span>
<span><span class="va">nrep</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># biologic noise distribution</span></span>
<span><span class="va">dlims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="st">"HlyE_IgA"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  <span class="st">"HlyE_IgG"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate cross-sectional data</span></span>
<span><span class="va">csdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim.cs.html">sim.cs</a></span><span class="op">(</span></span>
<span>  curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>  lambda <span class="op">=</span> <span class="va">lambda</span>,</span>
<span>  n.smpl <span class="op">=</span> <span class="va">nrep</span>,</span>
<span>  age.rng <span class="op">=</span> <span class="va">lifespan</span>,</span>
<span>  antigen_isos <span class="op">=</span> <span class="va">antibodies</span>,</span>
<span>  n.mc <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  renew.params <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  add.noise <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  noise_limits <span class="op">=</span> <span class="va">dlims</span>,</span>
<span>  format <span class="op">=</span> <span class="st">"long"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="noise-parameters">Noise parameters<a class="anchor" aria-label="anchor" href="#noise-parameters"></a>
</h3>
<p>We need to provide noise parameters for the analysis; here, we define
them directly in our code:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="va">cond</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  antigen_iso <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span>,</span>
<span>  nu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="co"># Biologic noise (nu)</span></span>
<span>  eps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="co"># M noise (eps)</span></span>
<span>  y.low <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, <span class="co"># low cutoff (llod)</span></span>
<span>  y.high <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5e6</span>, <span class="fl">5e6</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="co"># high cutoff (y.high)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualize-data">Visualize data<a class="anchor" aria-label="anchor" href="#visualize-data"></a>
</h3>
<p>We can plot the distribution of the antibody responses in the
simulated data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">csdata</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">antigen_iso</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="va">value</span></span>
<span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggbeeswarm/man/geom_beeswarm.html" class="external-link">geom_beeswarm</a></span><span class="op">(</span></span>
<span>    size <span class="op">=</span> <span class="fl">.2</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">.3</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">antigen_iso</span><span class="op">)</span>,</span>
<span>    show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>outlier.colour <span class="op">=</span> <span class="cn">NA</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_linedraw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"antigen - isotype"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="calculate-log-likelihood">calculate log-likelihood<a class="anchor" aria-label="anchor" href="#calculate-log-likelihood"></a>
</h3>
<p>We can calculate the log-likelihood of the data as a function of the
incidence rate directly:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ll_a</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/log_likelihood.html">log_likelihood</a></span><span class="op">(</span></span>
<span>    pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>    antigen_isos <span class="op">=</span> <span class="st">"HlyE_IgA"</span>,</span>
<span>    lambda <span class="op">=</span> <span class="fl">0.1</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -240.1535</span></span>
<span></span>
<span><span class="va">ll_g</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/log_likelihood.html">log_likelihood</a></span><span class="op">(</span></span>
<span>    pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>    antigen_isos <span class="op">=</span> <span class="st">"HlyE_IgG"</span>,</span>
<span>    lambda <span class="op">=</span> <span class="fl">0.1</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -339.8803</span></span>
<span></span>
<span><span class="va">ll_ag</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/log_likelihood.html">log_likelihood</a></span><span class="op">(</span></span>
<span>    pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>    antigen_isos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span>,</span>
<span>    lambda <span class="op">=</span> <span class="fl">0.1</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -580.0338</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ll_a</span> <span class="op">+</span> <span class="va">ll_g</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -580.0338</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="graph-log-likelihood">graph log-likelihood<a class="anchor" aria-label="anchor" href="#graph-log-likelihood"></a>
</h3>
<p>We can also graph the log-likelihoods, even without finding the MLEs,
using <code><a href="../reference/graph_loglik.html">graph_loglik()</a></code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lik_HlyE_IgA</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/graph_loglik.html">graph_loglik</a></span><span class="op">(</span></span>
<span>    pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>    antigen_isos <span class="op">=</span> <span class="st">"HlyE_IgA"</span>,</span>
<span>    log_x <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">lik_HlyE_IgG</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_loglik.html">graph_loglik</a></span><span class="op">(</span></span>
<span>  previous_plot <span class="op">=</span> <span class="va">lik_HlyE_IgA</span>,</span>
<span>  pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>  curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>  noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>  antigen_isos <span class="op">=</span> <span class="st">"HlyE_IgG"</span>,</span>
<span>  log_x <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">lik_both</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_loglik.html">graph_loglik</a></span><span class="op">(</span></span>
<span>  previous_plot <span class="op">=</span> <span class="va">lik_HlyE_IgG</span>,</span>
<span>  pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>  curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>  noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>  antigen_isos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span>,</span>
<span>  log_x <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">lik_both</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="estimate-incidence">estimate incidence<a class="anchor" aria-label="anchor" href="#estimate-incidence"></a>
</h3>
<p>We can estimate incidence with <code><a href="../reference/est.incidence.html">est.incidence()</a></code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/est.incidence.html">est.incidence</a></span><span class="op">(</span></span>
<span>  pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>  curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>  noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>  lambda_start <span class="op">=</span> <span class="fl">.1</span>,</span>
<span>  build_graph <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># print updates as the function runs</span></span>
<span>  print_graph <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># display the log-likelihood curve while</span></span>
<span>  <span class="co">#`est.incidence()` is running</span></span>
<span>  antigen_isos <span class="op">=</span> <span class="va">antibodies</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; nrow(curve_params) = 998</span></span>
<span><span class="co">#&gt; Initial negative log-likelihood: 580.033839865286</span></span>
<span><span class="co">#&gt; building likelihood graph</span></span>
<span><span class="co">#&gt; about to call `nlm()`</span></span>
<span><span class="co">#&gt; iteration = 0</span></span>
<span><span class="co">#&gt; Step:</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -2.302585</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 580.0338</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] -43.94475</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; iteration = 1</span></span>
<span><span class="co">#&gt; Step:</span></span>
<span><span class="co">#&gt; [1] 0.4684939</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -1.834091</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 565.4921</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] -18.4184</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; iteration = 2</span></span>
<span><span class="co">#&gt; Step:</span></span>
<span><span class="co">#&gt; [1] 0.3380391</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -1.496052</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 563.1786</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] 6.088605</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; iteration = 3</span></span>
<span><span class="co">#&gt; Step:</span></span>
<span><span class="co">#&gt; [1] -0.08398361</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -1.580036</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 562.9676</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] -0.665958</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; iteration = 4</span></span>
<span><span class="co">#&gt; Step:</span></span>
<span><span class="co">#&gt; [1] 0.008280263</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -1.571755</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 562.9636</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] -0.9964423</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; iteration = 5</span></span>
<span><span class="co">#&gt; Step:</span></span>
<span><span class="co">#&gt; [1] 0.002099482</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -1.569656</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 562.9634</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] 1.11877</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; iteration = 6</span></span>
<span><span class="co">#&gt; Step:</span></span>
<span><span class="co">#&gt; [1] -1.66162e-05</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -1.569673</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 562.9634</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] 0.1425471</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; iteration = 7</span></span>
<span><span class="co">#&gt; Parameter:</span></span>
<span><span class="co">#&gt; [1] -1.569673</span></span>
<span><span class="co">#&gt; Function Value</span></span>
<span><span class="co">#&gt; [1] 562.9634</span></span>
<span><span class="co">#&gt; Gradient:</span></span>
<span><span class="co">#&gt; [1] -0.008628721</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Last global step failed to locate a point lower than x.</span></span>
<span><span class="co">#&gt; Either x is an approximate local minimum of the function,</span></span>
<span><span class="co">#&gt; the function is too non-linear for this algorithm,</span></span>
<span><span class="co">#&gt; or steptol is too large.</span></span>
<span><span class="co">#&gt; Warning in est.incidence(pop_data = csdata, curve_params = dmcmc, noise_params = cond, : `nlm()` may not have reached the maximum likelihood estimate.</span></span>
<span><span class="co">#&gt; `nlm()` completed with the following convergence code:</span></span>
<span><span class="co">#&gt; 3: Last global step failed to locate a point lower than x. Either x is an approximate local minimum of the function, the function is too non-linear for this algorithm, or `stepmin` in `est.incidence()` (a.k.a. `steptol` in `nlm()`) is too large.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Elapsed time:</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.435   0.000   0.435</span></span></code></pre></div>
<p>We can extract summary statistics with <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est1</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 10</span></span></span>
<span><span class="co">#&gt;   est.start incidence.rate     SE CI.lwr CI.upr coverage log.lik iterations</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>       0.1          0.208 0.013<span style="text-decoration: underline;">7</span>  0.183  0.237     0.95   -<span style="color: #BB0000;">563.</span>          7</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: antigen.isos &lt;chr&gt;, nlm.convergence.code &lt;ord&gt;</span></span></span></code></pre></div>
<p>We can plot the log-likelihood curve with
<code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot()</a></code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">est1</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>We can set the x-axis to a logarithmic scale:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">est1</span>, log_x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="simulate-multiple-clusters-with-different-lambdas">Simulate multiple clusters with different lambdas<a class="anchor" aria-label="anchor" href="#simulate-multiple-clusters-with-different-lambdas"></a>
</h2>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>In the preceding code chunk, we have determined that we can use 3 CPU
cores to run computations in parallel.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># number of clusters</span></span>
<span><span class="va">nclus</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="co"># cross-sectional sample size</span></span>
<span><span class="va">nrep</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># incidence rate in e</span></span>
<span><span class="va">lambdas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.05</span>, <span class="fl">.1</span>, <span class="fl">.15</span>, <span class="fl">.2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim_df</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/sim.cs.multi.html">sim.cs.multi</a></span><span class="op">(</span></span>
<span>    n_cores <span class="op">=</span> <span class="va">n_cores</span>,</span>
<span>    lambdas <span class="op">=</span> <span class="va">lambdas</span>,</span>
<span>    nclus <span class="op">=</span> <span class="va">nclus</span>,</span>
<span>    n.smpl <span class="op">=</span> <span class="va">nrep</span>,</span>
<span>    age.rng <span class="op">=</span> <span class="va">lifespan</span>,</span>
<span>    antigen_isos <span class="op">=</span> <span class="va">antibodies</span>,</span>
<span>    renew.params <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    add.noise <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_limits <span class="op">=</span> <span class="va">dlims</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"long"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sim_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 8,000 × 6</span></span></span>
<span><span class="co">#&gt;      age id    antigen_iso value lambda.sim cluster</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  3.53 1     HlyE_IgA    0.875       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  3.53 1     HlyE_IgG    0.612       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  2.27 2     HlyE_IgA    0.599       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  2.27 2     HlyE_IgG    0.481       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  9.05 3     HlyE_IgA    0.577       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  9.05 3     HlyE_IgG    0.440       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  5.94 4     HlyE_IgA    0.873       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  5.94 4     HlyE_IgG    0.866       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  9.88 5     HlyE_IgA    0.633       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  9.88 5     HlyE_IgG    0.152       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 7,990 more rows</span></span></span></code></pre></div>
<p>We can plot the distributions of the simulated responses:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="va">value</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggbeeswarm/man/geom_beeswarm.html" class="external-link">geom_beeswarm</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">.2</span>, alpha <span class="op">=</span> <span class="fl">.3</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">antigen_iso</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>outlier.colour <span class="op">=</span> <span class="cn">NA</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">antigen_iso</span> <span class="op">+</span> <span class="va">lambda.sim</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_linedraw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<div class="section level3">
<h3 id="estimate-incidence-in-each-cluster">Estimate incidence in each cluster<a class="anchor" aria-label="anchor" href="#estimate-incidence-in-each-cluster"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ests</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/est.incidence.by.html">est.incidence.by</a></span><span class="op">(</span></span>
<span>    pop_data <span class="op">=</span> <span class="va">sim_df</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>    num_cores <span class="op">=</span> <span class="va">n_cores</span>,</span>
<span>    strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lambda.sim"</span>, <span class="st">"cluster"</span><span class="op">)</span>,</span>
<span>    curve_strata_varnames <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    noise_strata_varnames <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    build_graph <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># slows down the function substantially</span></span>
<span>    antigen_isos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Data has been stratified.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Here are the strata that will be analyzed:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 40 × 4</span></span></span>
<span><span class="co">#&gt;    Stratum    lambda.sim cluster     n</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Stratum 1        0.05       1   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Stratum 2        0.05       2   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Stratum 3        0.05       3   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Stratum 4        0.05       4   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Stratum 5        0.05       5   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Stratum 6        0.05       6   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Stratum 7        0.05       7   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Stratum 8        0.05       8   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Stratum 9        0.05       9   100</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Stratum 10       0.05      10   100</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 30 more rows</span></span></span>
<span><span class="co">#&gt; Setting up parallel processing with `num_cores` = 3.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Elapsed time for parallelized code:</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.145   0.032  17.552</span></span></code></pre></div>
<p><code>summary(ests)</code> produces a <code><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble()</a></code> with some
extra meta-data:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ests</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Seroincidence estimated given the following setup:</span></span>
<span><span class="co">#&gt; a) Antigen isotypes   : HlyE_IgG, HlyE_IgA </span></span>
<span><span class="co">#&gt; b) Strata       : lambda.sim, cluster </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Seroincidence estimates:</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 40 × 14</span></span></span>
<span><span class="co">#&gt;    Stratum    lambda.sim cluster     n est.start incidence.rate      SE CI.lwr</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Stratum 1        0.05       1   100       0.1         0.068<span style="text-decoration: underline;">0</span> 0.010<span style="text-decoration: underline;">8</span>  0.049<span style="text-decoration: underline;">8</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Stratum 2        0.05       2   100       0.1         0.060<span style="text-decoration: underline;">3</span> 0.009<span style="text-decoration: underline;">49</span> 0.044<span style="text-decoration: underline;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Stratum 3        0.05       3   100       0.1         0.055<span style="text-decoration: underline;">6</span> 0.009<span style="text-decoration: underline;">25</span> 0.040<span style="text-decoration: underline;">1</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Stratum 4        0.05       4   100       0.1         0.056<span style="text-decoration: underline;">8</span> 0.009<span style="text-decoration: underline;">72</span> 0.040<span style="text-decoration: underline;">6</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Stratum 5        0.05       5   100       0.1         0.035<span style="text-decoration: underline;">0</span> 0.007<span style="text-decoration: underline;">19</span> 0.023<span style="text-decoration: underline;">4</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Stratum 6        0.05       6   100       0.1         0.055<span style="text-decoration: underline;">8</span> 0.009<span style="text-decoration: underline;">15</span> 0.040<span style="text-decoration: underline;">5</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Stratum 7        0.05       7   100       0.1         0.068<span style="text-decoration: underline;">7</span> 0.010<span style="text-decoration: underline;">9</span>  0.050<span style="text-decoration: underline;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Stratum 8        0.05       8   100       0.1         0.040<span style="text-decoration: underline;">4</span> 0.007<span style="text-decoration: underline;">87</span> 0.027<span style="text-decoration: underline;">6</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Stratum 9        0.05       9   100       0.1         0.045<span style="text-decoration: underline;">8</span> 0.008<span style="text-decoration: underline;">26</span> 0.032<span style="text-decoration: underline;">2</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Stratum 10       0.05      10   100       0.1         0.042<span style="text-decoration: underline;">3</span> 0.007<span style="text-decoration: underline;">91</span> 0.029<span style="text-decoration: underline;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 30 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6 more variables: CI.upr &lt;dbl&gt;, coverage &lt;dbl&gt;, log.lik &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   iterations &lt;int&gt;, antigen.isos &lt;chr&gt;, nlm.convergence.code &lt;ord&gt;</span></span></span></code></pre></div>
<p>We can explore the summary table interactively using
<code><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">DT::datatable()</a></code></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/DT" class="external-link">DT</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ests</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/formatCurrency.html" class="external-link">formatRound</a></span><span class="op">(</span></span>
<span>    columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"incidence.rate"</span>,</span>
<span>      <span class="st">"SE"</span>,</span>
<span>      <span class="st">"CI.lwr"</span>,</span>
<span>      <span class="st">"CI.upr"</span>,</span>
<span>      <span class="st">"log.lik"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span></code></pre></div>
<div class="datatables html-widget html-fill-item" id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40"],["Stratum 1","Stratum 2","Stratum 3","Stratum 4","Stratum 5","Stratum 6","Stratum 7","Stratum 8","Stratum 9","Stratum 10","Stratum 11","Stratum 12","Stratum 13","Stratum 14","Stratum 15","Stratum 16","Stratum 17","Stratum 18","Stratum 19","Stratum 20","Stratum 21","Stratum 22","Stratum 23","Stratum 24","Stratum 25","Stratum 26","Stratum 27","Stratum 28","Stratum 29","Stratum 30","Stratum 31","Stratum 32","Stratum 33","Stratum 34","Stratum 35","Stratum 36","Stratum 37","Stratum 38","Stratum 39","Stratum 40"],[0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.15,0.15,0.15,0.15,0.15,0.15,0.15,0.15,0.15,0.15,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.2],[1,2,3,4,5,6,7,8,9,10,1,2,3,4,5,6,7,8,9,10,1,2,3,4,5,6,7,8,9,10,1,2,3,4,5,6,7,8,9,10],[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],[0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1],[0.06795718894195915,0.06030098217184402,0.05558888760990373,0.05675938980617022,0.0349862783830131,0.05582525640332849,0.06866914271527678,0.04040949854240591,0.04584525390565682,0.04227700743474198,0.1155830179167893,0.08644544993590164,0.1189537408438737,0.1007875116231457,0.1171376007588154,0.111299933371846,0.08312355795548666,0.1072901791952607,0.08859847406477356,0.116821640465934,0.1546222416137071,0.1822100498525061,0.1522315725205544,0.1442351440558003,0.1678008968968445,0.1068124143269848,0.207026185047287,0.1443480125438776,0.1586333500181221,0.1796287763197504,0.2101263828828624,0.2156180638856214,0.289435037121385,0.2489055371799111,0.2203432037212894,0.2060517710813382,0.2570183481006934,0.2512263114703198,0.2309805267234586,0.2351274813361965],[0.01077067347601596,0.009485643700181672,0.009251951086942779,0.009717233224825005,0.007185993808247099,0.009148392799218537,0.0109190088765435,0.007874229061745933,0.008262666642419602,0.007905160259570214,0.01524234919389117,0.01221747717601474,0.01561124316268649,0.01412221463024095,0.01546176476569239,null,0.01248893946521645,0.01452186602717585,0.01286269342345688,0.01519946740826132,null,null,null,0.01799110105038058,0.0198566421258936,0.01466516145089305,0.02282548617871606,0.01731780692160896,null,0.020548710941272,0.008675122737959305,0.02350467480567727,0.0300626361933526,0.02394597300775873,0.02266875785295196,0.02042454509403942,0.02845705023601874,0.02639519993174124,0.02483562477773263,0.0255129583221462],[0.04981116935981968,0.04430228836763975,0.04011603775629963,0.04057996129315553,0.02339190108876034,0.04048924073161508,0.05028204756795397,0.02758148267896478,0.03220199394024124,0.02930504806785981,0.0892571497097379,0.06553003944032035,0.09197465606413495,0.07658389901331542,0.09043584832001797,null,0.06192056829396279,0.08229031578235631,0.06665751506130892,0.09052632654409222,null,null,null,0.1129527682621206,0.1330661935695562,0.08161184921119174,0.1667926148528127,0.114101129391005,null,0.1435497186396075,0.1937931875032481,0.1741386089762676,0.2361237565471247,0.2061316404810301,0.1801061853642527,0.1696689568632356,0.206880312494603,0.204471728173104,0.1870906016938642,0.1900825002194119],[0.09271373445447365,0.08207721508004741,0.07702965194316205,0.07938963538913381,0.05232749875476488,0.07697005911162848,0.09378001472351194,0.05920376331668601,0.06526885600856046,0.06099103995661047,0.1496735451915886,0.1140364919423883,0.153846647177289,0.1326404457080405,0.1517232133763758,null,0.1115869262435827,0.1398850210053421,0.1177615097020422,0.150754992521483,null,null,null,0.1841812033550146,0.2116025133360951,0.1397945514607322,0.2569648622216008,0.1826129928474664,null,0.2247757612339068,0.2278361657201972,0.2669778387865723,0.354782771282645,0.3005553455754969,0.2695694616371463,0.2502363022127827,0.3193074800780402,0.3086718156045016,0.2851666692095313,0.2908470396574547],[0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95],[-277.634455479357,-261.0108658913256,-251.8450953445971,-224.1643001485195,-210.6180205712118,-249.3096116044587,-289.4774703306526,-215.4657805507197,-195.3027436339642,-176.2517020146271,-467.7204005948253,-386.8724060770388,-436.0910912779114,-352.9607712198921,-379.6744270479417,-408.7555585626662,-341.9545464598177,-327.5405383832615,-374.1130902094605,-458.069435242851,-479.2936203945241,-598.7595005989476,-458.6651203346023,-466.9896983405426,-527.4354975499546,-370.1536868270946,-587.3679413641643,-454.8311228502042,-497.59362989975,-525.3606158924175,-724.6432922453539,-571.8205405984764,-660.5942018817105,-632.6521684923993,-626.5397972352421,-621.4805910181133,-597.7276888423546,-539.8199543301278,-641.0430137607823,-622.3088300952627],[5,6,6,6,10,6,5,6,6,6,3,9,9,2,4,4,5,3,3,4,4,8,6,4,5,3,5,4,11,5,7,5,5,10,5,15,5,5,5,5],["HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA"],["1","1","1","1","2","1","1","1","1","1","1","3","3","1","1","2","1","1","1","1","3","2","1","1","1","1","1","1","3","1","3","1","1","3","1","3","1","1","3","1"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Stratum<\/th>\n      <th>lambda.sim<\/th>\n      <th>cluster<\/th>\n      <th>n<\/th>\n      <th>est.start<\/th>\n      <th>incidence.rate<\/th>\n      <th>SE<\/th>\n      <th>CI.lwr<\/th>\n      <th>CI.upr<\/th>\n      <th>coverage<\/th>\n      <th>log.lik<\/th>\n      <th>iterations<\/th>\n      <th>antigen.isos<\/th>\n      <th>nlm.convergence.code<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":6,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":7,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":8,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":9,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":11,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[2,3,4,5,6,7,8,9,10,11,12]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"Stratum","targets":1},{"name":"lambda.sim","targets":2},{"name":"cluster","targets":3},{"name":"n","targets":4},{"name":"est.start","targets":5},{"name":"incidence.rate","targets":6},{"name":"SE","targets":7},{"name":"CI.lwr","targets":8},{"name":"CI.upr","targets":9},{"name":"coverage","targets":10},{"name":"log.lik","targets":11},{"name":"iterations","targets":12},{"name":"antigen.isos","targets":13},{"name":"nlm.convergence.code","targets":14}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render","options.columnDefs.3.render","options.columnDefs.4.render"],"jsHooks":[]}</script><p>We can plot the likelihood for a single simulated cluster by
subsetting that simulation in <code>ests</code> and calling
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">ests</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
<p>We can also plot log-likelihood curves for several clusters at once
(your computer might struggle to plot many at once):</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">ests</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/plot-multiple-1.png" width="672"></p>
<p>The <code>log_x</code> argument also works here:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">ests</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, log_x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/plot-multiple-log-1.png" width="672"></p>
<div class="section level4">
<h4 id="nlm-convergence-codes">
<code>nlm()</code> convergence codes<a class="anchor" aria-label="anchor" href="#nlm-convergence-codes"></a>
</h4>
<p>Make sure to check the <code><a href="https://rdrr.io/r/stats/nlm.html" class="external-link">nlm()</a></code> exit codes (codes 3-5
indicate possible non-convergence):</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ests</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># removes extra meta-data</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Stratum</span>, <span class="va">nlm.convergence.code</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">nlm.convergence.code</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 8 × 2</span></span></span>
<span><span class="co">#&gt;   Stratum    nlm.convergence.code</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;ord&gt;</span>               </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Stratum 12 3                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Stratum 13 3                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Stratum 21 3                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Stratum 29 3                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Stratum 31 3                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> Stratum 34 3                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> Stratum 36 3                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> Stratum 39 3</span></span></code></pre></div>
<p>Solutions to <code><a href="https://rdrr.io/r/stats/nlm.html" class="external-link">nlm()</a></code> exit codes 3-5:</p>
<ul>
<li>3: decrease the <code>stepmin</code> argument to
<code><a href="../reference/est.incidence.html">est.incidence()</a></code>/<code><a href="../reference/est.incidence.by.html">est.incidence.by()</a></code>
</li>
<li>4: increase the <code>iterlim</code> argument to
<code><a href="../reference/est.incidence.html">est.incidence()</a></code>/<code><a href="../reference/est.incidence.by.html">est.incidence.by()</a></code>
</li>
<li>5: increase the <code>stepmax</code> argument to
<code><a href="../reference/est.incidence.html">est.incidence()</a></code>/<code><a href="../reference/est.incidence.by.html">est.incidence.by()</a></code>
</li>
</ul>
<p>We can extract the indices of problematic strata, if there are
any:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">problem_strata</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ests</span><span class="op">)</span><span class="op">$</span><span class="va">nlm.convergence.code</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; [1] 12 13 21 29 31 34 36 39</span></span></code></pre></div>
<p>If any clusters had problems, we can take a look:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">problem_strata</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">ests</span><span class="op">[</span><span class="va">problem_strata</span><span class="op">]</span>, log_x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
<p>If any of the fits don’t appear to be at the maximum likelihood, we
should re-run those clusters, adjusting the <code><a href="https://rdrr.io/r/stats/nlm.html" class="external-link">nlm()</a></code> settings
appropriately, to be sure.</p>
</div>
</div>
<div class="section level3">
<h3 id="plot-distribution-of-estimates-by-simulated-incidence-rate">plot distribution of estimates by simulated incidence rate<a class="anchor" aria-label="anchor" href="#plot-distribution-of-estimates-by-simulated-incidence-rate"></a>
</h3>
<p>Finally, we can look at our simulation results:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ests</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span>xvar <span class="op">=</span> <span class="st">"lambda.sim"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in FUN(X[[i]], ...): `nlm()` produced a negative hessian; something is wrong with the numerical derivatives.</span></span>
<span><span class="co">#&gt; The standard error of the incidence rate estimate cannot be calculated.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var.log.lambda): NaNs produced</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/graph-1.png" width="672"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Peter Teunis, Kristina Lai, Chris Orwa, Kristen Aiemjoy, Douglas Ezra Morrison.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
