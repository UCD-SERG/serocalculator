<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Generate a simulated cross-sectional sample and estimate seroincidence • serocalculator</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Generate a simulated cross-sectional sample and estimate seroincidence">
<meta name="description" content="A demonstration of the accuracy of the estimation approach">
<meta property="og:description" content="A demonstration of the accuracy of the estimation approach">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">serocalculator</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.3.0.9015</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/serocalculator.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/serocalculator.html">Introduction to serocalculator</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Methodology</h6></li>
    <li><a class="dropdown-item" href="../articles/methodology.html">Methodology</a></li>
    <li><a class="dropdown-item" href="../articles/simulate_xsectionalData.html">Generate a simulated cross-sectional sample and estimate seroincidence</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Examples</h6></li>
    <li><a class="dropdown-item" href="../articles/enteric_fever_example.html">Enteric Fever Seroincidence Vignette</a></li>
    <li><a class="dropdown-item" href="../articles/scrubTyphus_example.html">Scrub Typhus Seroincidence Vignette</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/UCD-SERG/serocalculator/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<link href="simulate_xsectionalData_files/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="simulate_xsectionalData_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="simulate_xsectionalData_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="simulate_xsectionalData_files/datatables-binding-0.33/datatables.js"></script><link href="simulate_xsectionalData_files/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="simulate_xsectionalData_files/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="simulate_xsectionalData_files/dt-core-1.13.6/js/jquery.dataTables.min.js"></script><link href="simulate_xsectionalData_files/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="simulate_xsectionalData_files/crosstalk-1.2.1/js/crosstalk.min.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Generate a simulated cross-sectional sample and estimate seroincidence</h1>
            <h3 data-toc-skip class="subtitle">Simulation of Enteric
Fever using HlyE IgG and/or HlyE IgA</h3>
            
      
      <small class="dont-index">Source: <a href="https://github.com/UCD-SERG/serocalculator/blob/main/vignettes/articles/simulate_xsectionalData.Rmd" class="external-link"><code>vignettes/articles/simulate_xsectionalData.Rmd</code></a></small>
      <div class="d-none name"><code>simulate_xsectionalData.Rmd</code></div>
    </div>

    
    
<p>This vignette shows how to simulate a cross-sectional sample of
seroresponses for incident infections as a Poisson process with
frequency <code>lambda</code>. Responses are generated for the
antibodies given in the <code>antigen_isos</code> argument.</p>
<p>Age range of the simulated cross-sectional record is
<code>lifespan</code>.</p>
<p>The size of the sample is <code>nrep</code>.</p>
<p>Each individual is simulated separately, but different antibodies are
modelled jointly.</p>
<p>Longitudinal parameters are calculated for an age:
<code>age_fixed</code> (fixed age). However, when <code>age_fixed</code>
is set to NA then the age at infection is used.</p>
<p>The boolean <code>renew_params</code> determines whether each
infection uses a new set of longitudinal parameters, sampled at random
from the posterior predictive output of the longitudinal model. If set
to <code>FALSE</code>, a parameter set is chosen at birth and kept,
but:</p>
<ol style="list-style-type: decimal">
<li><p>the baseline antibody levels (<code>y0</code>) are updated with
the simulated level (just) prior to infection, and</p></li>
<li><p>when <code>age_fixed = NA</code>, the selected parameter sample
is updated for the age when infection occurs.</p></li>
</ol>
<p>For our initial simulations, we will set
<code>renew_params = FALSE</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">renew_params</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span></code></pre></div>
<p>There is also a variable <code>n_mcmc_samples</code>: when
<code>n_mcmc_samples==0</code> then a random MC sample is chosen out of
the posterior set (1:4000). When <code>n_mcmc_samples</code> is given a
value in 1:4000, the chosen number is fixed and reused in any subsequent
infection. This is for diagnostic purposes.</p>
<div class="section level2">
<h2 id="simulate-a-single-dataset">Simulate a single dataset<a class="anchor" aria-label="anchor" href="#simulate-a-single-dataset"></a>
</h2>
<div class="section level3">
<h3 id="load-model-parameters">load model parameters<a class="anchor" aria-label="anchor" href="#load-model-parameters"></a>
</h3>
<p>Here we load in longitudinal parameters; these are modeled from all
SEES cases across all ages and countries:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ucd-serg.github.io/serocalculator/">serocalculator</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Attaching core tidyverse packages</span> ──────────────────────── tidyverse 2.0.0 ──</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">dplyr    </span> 1.1.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">readr    </span> 2.1.5</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">forcats  </span> 1.0.0     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">stringr  </span> 1.5.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">ggplot2  </span> 3.5.1     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tibble   </span> 3.2.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">lubridate</span> 1.9.4     <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">tidyr    </span> 1.3.1</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #0000BB;">purrr    </span> 1.0.2     </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Conflicts</span> ────────────────────────────────────────── tidyverse_conflicts() ──</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">filter()</span> masks <span style="color: #0000BB;">stats</span>::filter()</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> <span style="color: #0000BB;">dplyr</span>::<span style="color: #00BB00;">lag()</span>    masks <span style="color: #0000BB;">stats</span>::lag()</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use the conflicted package (<span style="color: #0000BB; font-style: italic;">&lt;http://conflicted.r-lib.org/&gt;</span>) to force all conflicts to become errors</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eclarke/ggbeeswarm" class="external-link">ggbeeswarm</a></span><span class="op">)</span> <span class="co"># for plotting</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">dmcmc</span> <span class="op">&lt;-</span></span>
<span>  <span class="st">"https://osf.io/download/rtw5k"</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/load_curve_params.html">load_curve_params</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">iter</span> <span class="op">&lt;</span> <span class="fl">500</span><span class="op">)</span> <span class="co"># reduce number of mcmc samples for speed</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualize-antibody-decay-model">visualize antibody decay model<a class="anchor" aria-label="anchor" href="#visualize-antibody-decay-model"></a>
</h3>
<p>We can graph individual MCMC samples from the posterior distribution
of model parameters using a <code><a href="../reference/autoplot.curve_params.html">autoplot.curve_params()</a></code> method
for the <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot()</a></code> function:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dmcmc</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span>n_curves <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<p>We can use a logarithmic scale for the x-axis if desired:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dmcmc</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span>log_x <span class="op">=</span> <span class="cn">TRUE</span>, n_curves <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>We can graph the median, 10%, and 90% quantiles of the model using
the <code><a href="../reference/graph.curve.params.html">graph.curve.params()</a></code> function:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Specify the antibody-isotype responses to include in analyses</span></span>
<span><span class="va">antibodies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgA"</span>, <span class="st">"HlyE_IgG"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dmcmc</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/graph.curve.params.html">graph.curve.params</a></span><span class="op">(</span>antigen_isos <span class="op">=</span> <span class="va">antibodies</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 47 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/graph-curve-params-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="simulate-cross-sectional-data">Simulate cross-sectional data<a class="anchor" aria-label="anchor" href="#simulate-cross-sectional-data"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set seed to reproduce results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">54321</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulated incidence rate per person-year</span></span>
<span><span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="co"># range covered in simulations</span></span>
<span><span class="va">lifespan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co"># cross-sectional sample size</span></span>
<span><span class="va">nrep</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># biologic noise distribution</span></span>
<span><span class="va">dlims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="st">"HlyE_IgA"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  <span class="st">"HlyE_IgG"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">verbose</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span> <span class="co"># whether to print verbose updates as the function runs</span></span>
<span></span>
<span><span class="co"># generate cross-sectional data</span></span>
<span><span class="va">csdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_pop_data.html">sim_pop_data</a></span><span class="op">(</span></span>
<span>  curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>  lambda <span class="op">=</span> <span class="va">lambda</span>,</span>
<span>  n_samples <span class="op">=</span> <span class="va">nrep</span>,</span>
<span>  age_range <span class="op">=</span> <span class="va">lifespan</span>,</span>
<span>  antigen_isos <span class="op">=</span> <span class="va">antibodies</span>,</span>
<span>  n_mcmc_samples <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  renew_params <span class="op">=</span> <span class="va">renew_params</span>,</span>
<span>  add_noise <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  noise_limits <span class="op">=</span> <span class="va">dlims</span>,</span>
<span>  format <span class="op">=</span> <span class="st">"long"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="noise-parameters">Noise parameters<a class="anchor" aria-label="anchor" href="#noise-parameters"></a>
</h3>
<p>We need to provide noise parameters for the analysis; here, we define
them directly in our code:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="va">cond</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  antigen_iso <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span>,</span>
<span>  nu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="co"># Biologic noise (nu)</span></span>
<span>  eps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="co"># M noise (eps)</span></span>
<span>  y.low <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, <span class="co"># low cutoff (llod)</span></span>
<span>  y.high <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5e6</span>, <span class="fl">5e6</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="co"># high cutoff (y.high)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualize-data">Visualize data<a class="anchor" aria-label="anchor" href="#visualize-data"></a>
</h3>
<p>We can plot the distribution of the antibody responses in the
simulated data.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">csdata</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">antigen_iso</span><span class="op">)</span>,</span>
<span>      y <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggbeeswarm/man/geom_beeswarm.html" class="external-link">geom_beeswarm</a></span><span class="op">(</span></span>
<span>    size <span class="op">=</span> <span class="fl">.2</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">.3</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">antigen_iso</span><span class="op">)</span>,</span>
<span>    show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>outlier.colour <span class="op">=</span> <span class="cn">NA</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_linedraw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"antigen - isotype"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="calculate-log-likelihood">calculate log-likelihood<a class="anchor" aria-label="anchor" href="#calculate-log-likelihood"></a>
</h3>
<p>We can calculate the log-likelihood of the data as a function of the
incidence rate directly:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ll_a</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/log_likelihood.html">log_likelihood</a></span><span class="op">(</span></span>
<span>    pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>    antigen_isos <span class="op">=</span> <span class="st">"HlyE_IgA"</span>,</span>
<span>    lambda <span class="op">=</span> <span class="fl">0.1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -266.4948</span></span>
<span></span>
<span><span class="va">ll_g</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/log_likelihood.html">log_likelihood</a></span><span class="op">(</span></span>
<span>    pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>    antigen_isos <span class="op">=</span> <span class="st">"HlyE_IgG"</span>,</span>
<span>    lambda <span class="op">=</span> <span class="fl">0.1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -406.6665</span></span>
<span></span>
<span><span class="va">ll_ag</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/log_likelihood.html">log_likelihood</a></span><span class="op">(</span></span>
<span>    pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>    antigen_isos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span>,</span>
<span>    lambda <span class="op">=</span> <span class="fl">0.1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -673.1613</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ll_a</span> <span class="op">+</span> <span class="va">ll_g</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -673.1613</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="graph-log-likelihood">graph log-likelihood<a class="anchor" aria-label="anchor" href="#graph-log-likelihood"></a>
</h3>
<p>We can also graph the log-likelihoods, even without finding the MLEs,
using <code><a href="../reference/graph_loglik.html">graph_loglik()</a></code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lik_HlyE_IgA</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/graph_loglik.html">graph_loglik</a></span><span class="op">(</span></span>
<span>    pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>    antigen_isos <span class="op">=</span> <span class="st">"HlyE_IgA"</span>,</span>
<span>    log_x <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">lik_HlyE_IgG</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_loglik.html">graph_loglik</a></span><span class="op">(</span></span>
<span>  previous_plot <span class="op">=</span> <span class="va">lik_HlyE_IgA</span>,</span>
<span>  pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>  curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>  noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>  antigen_isos <span class="op">=</span> <span class="st">"HlyE_IgG"</span>,</span>
<span>  log_x <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">lik_both</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graph_loglik.html">graph_loglik</a></span><span class="op">(</span></span>
<span>  previous_plot <span class="op">=</span> <span class="va">lik_HlyE_IgG</span>,</span>
<span>  pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>  curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>  noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>  antigen_isos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span>,</span>
<span>  log_x <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">lik_both</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="estimate-incidence">estimate incidence<a class="anchor" aria-label="anchor" href="#estimate-incidence"></a>
</h3>
<p>We can estimate incidence with <code><a href="../reference/est.incidence.html">est.incidence()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/est.incidence.html">est.incidence</a></span><span class="op">(</span></span>
<span>  pop_data <span class="op">=</span> <span class="va">csdata</span>,</span>
<span>  curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>  noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>  lambda_start <span class="op">=</span> <span class="fl">.1</span>,</span>
<span>  build_graph <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="va">verbose</span>,</span>
<span>  print_graph <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># display the log-likelihood curve while</span></span>
<span>  <span class="co">#`est.incidence()` is running</span></span>
<span>  antigen_isos <span class="op">=</span> <span class="va">antibodies</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can extract summary statistics with <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">est1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: `nlm()` produced a negative hessian; something is wrong with the numerical</span></span>
<span><span class="co">#&gt; derivatives.</span></span>
<span><span class="co">#&gt; Warning in sqrt(var_log_lambda): NaNs produced</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 10</span></span></span>
<span><span class="co">#&gt;   est.start incidence.rate    SE CI.lwr CI.upr coverage log.lik iterations</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>       0.1          0.253   <span style="color: #BB0000;">NaN</span>    <span style="color: #BB0000;">NaN</span>    <span style="color: #BB0000;">NaN</span>     0.95   -<span style="color: #BB0000;">645.</span>          9</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: antigen.isos &lt;chr&gt;, nlm.convergence.code &lt;ord&gt;</span></span></span></code></pre></div>
<p>We can plot the log-likelihood curve with
<code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot()</a></code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">est1</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p>We can set the x-axis to a logarithmic scale:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">est1</span>, log_x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="simulate-multiple-clusters-with-different-lambdas">Simulate multiple clusters with different lambdas<a class="anchor" aria-label="anchor" href="#simulate-multiple-clusters-with-different-lambdas"></a>
</h2>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>In the preceding code chunk, we have determined that we can use 3 CPU
cores to run computations in parallel.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># number of clusters</span></span>
<span><span class="va">nclus</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="co"># cross-sectional sample size</span></span>
<span><span class="va">nrep</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># incidence rate in e</span></span>
<span><span class="va">lambdas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.05</span>, <span class="fl">.1</span>, <span class="fl">.15</span>, <span class="fl">.2</span>, <span class="fl">.5</span>, <span class="fl">.8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim_df</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/sim_pop_data_multi.html">sim_pop_data_multi</a></span><span class="op">(</span></span>
<span>    n_cores <span class="op">=</span> <span class="va">n_cores</span>,</span>
<span>    lambdas <span class="op">=</span> <span class="va">lambdas</span>,</span>
<span>    nclus <span class="op">=</span> <span class="va">nclus</span>,</span>
<span>    n_samples <span class="op">=</span> <span class="va">nrep</span>,</span>
<span>    age_range <span class="op">=</span> <span class="va">lifespan</span>,</span>
<span>    antigen_isos <span class="op">=</span> <span class="va">antibodies</span>,</span>
<span>    renew_params <span class="op">=</span> <span class="va">renew_params</span>,</span>
<span>    add_noise <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_limits <span class="op">=</span> <span class="va">dlims</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"long"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sim_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6,000 × 6</span></span></span>
<span><span class="co">#&gt;      age id    antigen_iso value lambda.sim cluster</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  3.53 1     HlyE_IgA    0.842       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  3.53 1     HlyE_IgG    0.767       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  2.27 2     HlyE_IgA    0.428       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  2.27 2     HlyE_IgG    0.544       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  9.05 3     HlyE_IgA    0.528       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  9.05 3     HlyE_IgG    0.768       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  5.94 4     HlyE_IgA    0.412       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  5.94 4     HlyE_IgG    0.683       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  9.88 5     HlyE_IgA    0.467       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  9.88 5     HlyE_IgG    0.285       0.05       1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 5,990 more rows</span></span></span></code></pre></div>
<p>We can plot the distributions of the simulated responses:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="va">value</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/ggbeeswarm/man/geom_beeswarm.html" class="external-link">geom_beeswarm</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">.2</span>, alpha <span class="op">=</span> <span class="fl">.3</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">antigen_iso</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>outlier.colour <span class="op">=</span> <span class="cn">NA</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">antigen_iso</span> <span class="op">+</span> <span class="va">lambda.sim</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_linedraw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<div class="section level3">
<h3 id="estimate-incidence-in-each-cluster">Estimate incidence in each cluster<a class="anchor" aria-label="anchor" href="#estimate-incidence-in-each-cluster"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ests</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/est.incidence.by.html">est.incidence.by</a></span><span class="op">(</span></span>
<span>    pop_data <span class="op">=</span> <span class="va">sim_df</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>    num_cores <span class="op">=</span> <span class="va">n_cores</span>,</span>
<span>    strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lambda.sim"</span>, <span class="st">"cluster"</span><span class="op">)</span>,</span>
<span>    curve_strata_varnames <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    noise_strata_varnames <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    verbose <span class="op">=</span> <span class="va">verbose</span>,</span>
<span>    build_graph <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># slows down the function substantially</span></span>
<span>    antigen_isos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><code>summary(ests)</code> produces a <code><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble()</a></code> with some
extra meta-data:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ests_summary</span> <span class="op">&lt;-</span> <span class="va">ests</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in sqrt(var_log_lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in sqrt(var_log_lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Seroincidence estimated given the following setup:</span></span>
<span><span class="co">#&gt; a) Antigen isotypes   : HlyE_IgG, HlyE_IgA </span></span>
<span><span class="co">#&gt; b) Strata       : lambda.sim, cluster </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Seroincidence estimates:</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 30 × 14</span></span></span>
<span><span class="co">#&gt;    Stratum    lambda.sim cluster     n est.start incidence.rate      SE CI.lwr</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Stratum 1        0.05       1   100       0.1         0.074<span style="text-decoration: underline;">1</span> 0.011<span style="text-decoration: underline;">1</span>  0.055<span style="text-decoration: underline;">2</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Stratum 2        0.05       2   100       0.1         0.060<span style="text-decoration: underline;">5</span> 0.009<span style="text-decoration: underline;">92</span> 0.043<span style="text-decoration: underline;">8</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Stratum 3        0.05       3   100       0.1         0.055<span style="text-decoration: underline;">3</span> 0.009<span style="text-decoration: underline;">52</span> 0.039<span style="text-decoration: underline;">5</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Stratum 4        0.05       4   100       0.1         0.053<span style="text-decoration: underline;">5</span> 0.009<span style="text-decoration: underline;">30</span> 0.038<span style="text-decoration: underline;">1</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Stratum 5        0.05       5   100       0.1         0.052<span style="text-decoration: underline;">2</span> 0.008<span style="text-decoration: underline;">98</span> 0.037<span style="text-decoration: underline;">2</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Stratum 6        0.1        1   100       0.1         0.092<span style="text-decoration: underline;">8</span> 0.013<span style="text-decoration: underline;">1</span>  0.070<span style="text-decoration: underline;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Stratum 7        0.1        2   100       0.1         0.080<span style="text-decoration: underline;">8</span> 0.012<span style="text-decoration: underline;">3</span>  0.060<span style="text-decoration: underline;">0</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Stratum 8        0.1        3   100       0.1         0.086<span style="text-decoration: underline;">4</span> 0.054<span style="text-decoration: underline;">7</span>  0.025<span style="text-decoration: underline;">0</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Stratum 9        0.1        4   100       0.1         0.073<span style="text-decoration: underline;">5</span> 0.011<span style="text-decoration: underline;">2</span>  0.054<span style="text-decoration: underline;">5</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Stratum 10       0.1        5   100       0.1         0.117  0.014<span style="text-decoration: underline;">9</span>  0.091<span style="text-decoration: underline;">1</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 20 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 6 more variables: CI.upr &lt;dbl&gt;, coverage &lt;dbl&gt;, log.lik &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   iterations &lt;int&gt;, antigen.isos &lt;chr&gt;, nlm.convergence.code &lt;ord&gt;</span></span></span></code></pre></div>
<p>We can explore the summary table interactively using
<code><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">DT::datatable()</a></code></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/DT" class="external-link">DT</a></span><span class="op">)</span></span>
<span><span class="va">ests_summary</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span>options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>scrollX <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">DT</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/formatCurrency.html" class="external-link">formatRound</a></span><span class="op">(</span></span>
<span>    columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"incidence.rate"</span>,</span>
<span>      <span class="st">"SE"</span>,</span>
<span>      <span class="st">"CI.lwr"</span>,</span>
<span>      <span class="st">"CI.upr"</span>,</span>
<span>      <span class="st">"log.lik"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="datatables html-widget html-fill-item" id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30"],["Stratum 1","Stratum 2","Stratum 3","Stratum 4","Stratum 5","Stratum 6","Stratum 7","Stratum 8","Stratum 9","Stratum 10","Stratum 11","Stratum 12","Stratum 13","Stratum 14","Stratum 15","Stratum 16","Stratum 17","Stratum 18","Stratum 19","Stratum 20","Stratum 21","Stratum 22","Stratum 23","Stratum 24","Stratum 25","Stratum 26","Stratum 27","Stratum 28","Stratum 29","Stratum 30"],[0.05,0.05,0.05,0.05,0.05,0.1,0.1,0.1,0.1,0.1,0.15,0.15,0.15,0.15,0.15,0.2,0.2,0.2,0.2,0.2,0.5,0.5,0.5,0.5,0.5,0.8,0.8,0.8,0.8,0.8],[1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5,1,2,3,4,5],[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],[0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1,0.1],[0.07406443693872768,0.06047533742097708,0.05530097091551151,0.05353933027003122,0.05216720328113359,0.0927734319035305,0.08082809856523068,0.08637455361054358,0.07349418926518224,0.1169132815275649,0.175605221923722,0.1584049853307516,0.1742226497303219,0.1318783890914523,0.1674678787894752,0.2285352397725761,0.2342771149252648,0.2698937568787087,0.2003986001343931,0.2410575955984756,0.7153829169488352,0.4923966270906603,0.5929622265988261,0.4467445375041337,0.6261948440409133,0.9598918162487943,1.103012833333245,1.015890024445381,0.9958259431799198,0.7213749507564793],[0.01110962813799731,0.009919907205197576,0.00952324086059855,0.009300493871239379,0.008983866591379265,0.01313730684303332,0.01226208957954114,0.05470577714925499,0.01119522256714777,0.01486562740362468,0.0210802063173122,0.01858497135486892,0.01982472877749467,0.0168644510388268,null,0.0240593127638567,0.02581289040643204,0.02770530524382811,0.02231620880064603,0.02560481058599938,0.07449133697077399,0.04920727450828774,0.06034877036643961,0.04419227811146998,0.06248814376147378,0.09613980349800083,0.1239540447880681,0.1058245885020346,null,0.07322861097430253],[0.05519883653821354,0.04384840235472925,0.03945930968202677,0.0380897307867458,0.03722285223023547,0.07028911591618002,0.06003854654787073,0.02496162464007187,0.05452443552881417,0.09112400927236472,0.1387894646186497,0.1258638617231357,0.1393948458862121,0.1026415013430665,null,0.1859267792149711,0.1887746252549975,0.2207063139297796,0.1611037469140386,0.1957525138427793,0.5833171118078381,0.4048096941804856,0.4857311260453053,0.3680084633506626,0.5149533260164496,0.7888030260767379,0.8849617381374054,0.8282808049469984,null,0.5912258552581484],[0.09937783408266566,0.08340706251037622,0.07750255665499442,0.07525545144469575,0.07311146070543612,0.1224501056098468,0.1088164503193215,0.2988813275977212,0.09906376477555623,0.1500012511158129,0.2221868500725951,0.1993593636339487,0.2177521807645025,0.1694432493853162,null,0.2809081942818022,0.2907475859298665,0.3300432991929687,0.2492778703480601,0.2968481132374567,0.8773490568039722,0.5989343680642187,0.7238659071237751,0.5423263366625585,0.7614670357346093,1.168089204074342,1.374790861646188,1.245993551466736,null,0.8801743275447541],[0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95,0.95],[-308.5506432140949,-287.5211057998044,-275.5633578848941,-346.3594472251274,-214.8886106953061,-447.7143602380523,-353.2938013305787,-394.9824745849178,-307.6857495842024,-377.982442669031,-514.5099342376996,-555.1987018498381,-457.5335754262186,-450.7636539606924,-538.101524718801,-568.3218213904451,-627.6926626109941,-649.4305676000356,-639.2450235286121,-624.0908605645145,-910.9528151881692,-768.250523882113,-892.48660948734,-764.9493908138343,-794.1111676848654,-990.5875696021548,-1018.048127271808,-933.69916754004,-934.4884644374708,-813.8419075853976],[5,5,6,6,6,3,5,6,5,4,11,5,5,4,5,5,5,6,5,5,5,5,5,5,6,5,11,5,12,5],["HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA","HlyE_IgG+HlyE_IgA"],["1","1","1","1","1","1","1","2","1","1","3","1","1","1","2","1","1","1","1","1","1","1","1","1","1","1","3","1","1","1"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Stratum<\/th>\n      <th>lambda.sim<\/th>\n      <th>cluster<\/th>\n      <th>n<\/th>\n      <th>est.start<\/th>\n      <th>incidence.rate<\/th>\n      <th>SE<\/th>\n      <th>CI.lwr<\/th>\n      <th>CI.upr<\/th>\n      <th>coverage<\/th>\n      <th>log.lik<\/th>\n      <th>iterations<\/th>\n      <th>antigen.isos<\/th>\n      <th>nlm.convergence.code<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"targets":6,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":7,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":8,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":9,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"targets":11,"render":"function(data, type, row, meta) {\n    return type !== 'display' ? data : DTWidget.formatRound(data, 2, 3, \",\", \".\", null);\n  }"},{"className":"dt-right","targets":[2,3,4,5,6,7,8,9,10,11,12]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"Stratum","targets":1},{"name":"lambda.sim","targets":2},{"name":"cluster","targets":3},{"name":"n","targets":4},{"name":"est.start","targets":5},{"name":"incidence.rate","targets":6},{"name":"SE","targets":7},{"name":"CI.lwr","targets":8},{"name":"CI.upr","targets":9},{"name":"coverage","targets":10},{"name":"log.lik","targets":11},{"name":"iterations","targets":12},{"name":"antigen.isos","targets":13},{"name":"nlm.convergence.code","targets":14}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":["options.columnDefs.0.render","options.columnDefs.1.render","options.columnDefs.2.render","options.columnDefs.3.render","options.columnDefs.4.render"],"jsHooks":[]}</script><p>We can plot the likelihood for a single simulated cluster by
subsetting that simulation in <code>ests</code> and calling
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">ests</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
<p>We can also plot log-likelihood curves for several clusters at once
(your computer might struggle to plot many at once):</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">ests</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/plot-multiple-1.png" width="672"></p>
<p>The <code>log_x</code> argument also works here:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">ests</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, log_x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/plot-multiple-log-1.png" width="672"></p>
<div class="section level4">
<h4 id="nlm-convergence-codes">
<code>nlm()</code> convergence codes<a class="anchor" aria-label="anchor" href="#nlm-convergence-codes"></a>
</h4>
<p>Make sure to check the <code><a href="https://rdrr.io/r/stats/nlm.html" class="external-link">nlm()</a></code> exit codes (codes 3-5
indicate possible non-convergence):</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ests_summary</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># removes extra meta-data</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Stratum</span>, <span class="va">nlm.convergence.code</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">nlm.convergence.code</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 2</span></span></span>
<span><span class="co">#&gt;   Stratum    nlm.convergence.code</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;ord&gt;</span>               </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Stratum 11 3                   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Stratum 27 3</span></span></code></pre></div>
<p>Solutions to <code><a href="https://rdrr.io/r/stats/nlm.html" class="external-link">nlm()</a></code> exit codes 3-5:</p>
<ul>
<li>3: decrease the <code>stepmin</code> argument to
<code><a href="../reference/est.incidence.html">est.incidence()</a></code>/<code><a href="../reference/est.incidence.by.html">est.incidence.by()</a></code>
</li>
<li>4: increase the <code>iterlim</code> argument to
<code><a href="../reference/est.incidence.html">est.incidence()</a></code>/<code><a href="../reference/est.incidence.by.html">est.incidence.by()</a></code>
</li>
<li>5: increase the <code>stepmax</code> argument to
<code><a href="../reference/est.incidence.html">est.incidence()</a></code>/<code><a href="../reference/est.incidence.by.html">est.incidence.by()</a></code>
</li>
</ul>
<p>We can extract the indices of problematic strata, if there are
any:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">problem_strata</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">ests_summary</span><span class="op">$</span><span class="va">nlm.convergence.code</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 11 27</span></span></code></pre></div>
<p>If any clusters had problems, we can take a look:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">problem_strata</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">ests</span><span class="op">[</span><span class="va">problem_strata</span><span class="op">]</span>, log_x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
<p>If any of the fits don’t appear to be at the maximum likelihood, we
should re-run those clusters, adjusting the <code><a href="https://rdrr.io/r/stats/nlm.html" class="external-link">nlm()</a></code> settings
appropriately, to be sure.</p>
</div>
</div>
<div class="section level3">
<h3 id="plot-distribution-of-estimates-by-simulated-incidence-rate">plot distribution of estimates by simulated incidence rate<a class="anchor" aria-label="anchor" href="#plot-distribution-of-estimates-by-simulated-incidence-rate"></a>
</h3>
<p>Finally, we can look at our simulation results:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">ests_summary</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span>xvar <span class="op">=</span> <span class="st">"lambda.sim"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span></span>
<span>    fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"data-generating incidence rate"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in scale_x_log10(): <span style="color: #00BB00;">log-10</span> transformation introduced</span></span>
<span><span class="co">#&gt; infinite values.</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/graph-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="effect-of-renew_params">Effect of <code>renew_params</code><a class="anchor" aria-label="anchor" href="#effect-of-renew_params"></a>
</h3>
<p>Setting <code>renew_params = TRUE</code> is more realistic, but not
is accounted for by the current method; for population samples from
populations with high incidence rates, there may be bias:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_df_renew</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/sim_pop_data_multi.html">sim_pop_data_multi</a></span><span class="op">(</span></span>
<span>    n_cores <span class="op">=</span> <span class="va">n_cores</span>,</span>
<span>    lambdas <span class="op">=</span> <span class="va">lambdas</span>,</span>
<span>    nclus <span class="op">=</span> <span class="va">nclus</span>,</span>
<span>    n_samples <span class="op">=</span> <span class="va">nrep</span>,</span>
<span>    age_range <span class="op">=</span> <span class="va">lifespan</span>,</span>
<span>    antigen_isos <span class="op">=</span> <span class="va">antibodies</span>,</span>
<span>    renew_params <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    add_noise <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_limits <span class="op">=</span> <span class="va">dlims</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"long"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">ests_renew</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/est.incidence.by.html">est.incidence.by</a></span><span class="op">(</span></span>
<span>    pop_data <span class="op">=</span> <span class="va">sim_df_renew</span>,</span>
<span>    curve_params <span class="op">=</span> <span class="va">dmcmc</span>,</span>
<span>    noise_params <span class="op">=</span> <span class="va">cond</span>,</span>
<span>    num_cores <span class="op">=</span> <span class="va">n_cores</span>,</span>
<span>    strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lambda.sim"</span>, <span class="st">"cluster"</span><span class="op">)</span>,</span>
<span>    curve_strata_varnames <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    noise_strata_varnames <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    verbose <span class="op">=</span> <span class="va">verbose</span>,</span>
<span>    build_graph <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># slows down the function substantially</span></span>
<span>    antigen_isos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HlyE_IgG"</span>, <span class="st">"HlyE_IgA"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">ests_renew_summary</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">ests_renew</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in sqrt(var_log_lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in sqrt(var_log_lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in sqrt(var_log_lambda): NaNs produced</span></span>
<span><span class="co">#&gt; Warning in sqrt(var_log_lambda): NaNs produced</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">ests_renew_summary</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span>xvar <span class="op">=</span> <span class="st">"lambda.sim"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span></span>
<span>    fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"data-generating incidence rate"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in scale_x_log10(): <span style="color: #00BB00;">log-10</span> transformation introduced</span></span>
<span><span class="co">#&gt; infinite values.</span></span></code></pre></div>
<p><img src="simulate_xsectionalData_files/figure-html/graph_renew-1.png" width="672"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Peter Teunis, Kristina Lai, Chris Orwa, Kristen Aiemjoy, Douglas Ezra Morrison.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
