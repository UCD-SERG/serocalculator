---
title: "Scrub Typhus Seroincidence Vignette"
author: "UC Davis Seroepidemiology Research Group (SERG)"
date: "First Published: 2024-08-01 | Updated: `r Sys.Date()`"
output: 
  bookdown::html_document2:
    base_format: rmarkdown::html_vignette
    toc: true
vignette: >
  %\VignetteIndexEntry{Scrub Typhus Seroincidence Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: ../references.bib

---
## Introduction

This vignette reproduces the analysis for: [**Estimating the Seroincidence of Scrub Typhus using Antibody Dynamics after Infection**](https://www.ajtmh.org/view/journals/tpmd/111/2/article-p267.xml) (@Aiemjoy_2024_scrub).

**Citation:** Aiemjoy, Kristen, Nishan Katuwal, Krista Vaidya, Sony Shrestha, Melina Thapa, Peter Teunis, Isaac I. Bogoch et al. "Estimating the Seroincidence of Scrub Typhus using Antibody Dynamics after Infection." The American Journal of Tropical Medicine and Hygiene 111, no. 2 (2024): 267. https://doi.org/10.4269/ajtmh.23-0475 

## Methods

The **serocalculator** R package provides a rapid and computationally simple method for calculating seroconversion rates, 
as originally published in @Simonsen_2009 and @Teunis_2012, 
and further developed in subsequent publications by @de_Graaf_2014, @Teunis_2016, and @Teunis_2020. 
In short, 
longitudinal seroresponses from confirmed cases with a known symptom onset date 
are assumed to represent the time course of human serum antibodies against a specific pathogen. 
Therefore, 
by using these longitudinal antibody dynamics with any cross–sectional sample of the same antibodies in a human population, 
an incidence estimate can be calculated. 

### The Seroincidence Estimator

The **serocalculator** package was designed to calculate the incidence of seroconversion by using the longitudinal seroresponse characteristics. 
The distribution of serum antibody concentrations in a cross–sectional population sample is calculated as a function of the longitudinal seroresponse and the frequency of seroconversion (or seroincidence). 
Given the seroresponse, this marginal distribution of antibody concentrations can be fitted to the cross-sectional data and thereby providing a means to estimate the seroincidence.



## Scrub Typhus Seroincidence

Scrub typhus, a vector-borne bacterial infection, is an important but neglected disease globally. Accurately characterizing burden is challenging due to non-specific symptoms and limited diagnostics. Prior seroepidemiology studies have struggled to find consensus cutoffs that permit comparing estimates across contexts and time. In this study, we present a novel approach that does not require a cutoff and instead uses information about antibody kinetics after infection to estimate seroincidence. We use data from three cohorts of scrub typhus patients in Chiang Rai, Thailand, and Vellore, India to characterize antibody kinetics after infection and two population serosurveys in the Kathmandu valley, Nepal, and Tamil Nadu, India to estimate seroincidence. The samples were tested for IgM and IgG responses to Orientia tsutsugamushi-derived recombinant 56-kDa antigen using commercial ELISA kits. These antigens (OT56kdaIgG and OT56kdaIgM) represent IgG and IgM responses to a 56 kilodalton antigen on the membrane of *Orientia tsutsugamushi* (OT) that have been found to be specific to this organism and are used in diagnosis. We used with-host Bayesian hierarchical models to characterize antibody responses after scrub typhus infection and used the joint distributions of the peak antibody titers and decay rates to estimate population-level incidence rates in the cross-sectional serosurveys. 
 

```{r, include = FALSE}
knitr::opts_chunk$set(
  fig.height = 4, fig.width = 7,
  message = FALSE,
  collapse = TRUE,
  comment = "#>"
)
```

### Load packages
The first step in conducting this analysis is to load our necessary packages. 
If you haven't installed already, you will need to do so before loading. 
We will also need to have the `tidyverse` and `mixtools` packages installed
for data manipulation and graphics operations we will perform in this vignette.
Please see the websites for 
[`serocalculator`](https://ucd-serg.github.io/serocalculator/#installing-the-serocalculator-package),
[`tidyverse`](https://tidyverse.tidyverse.org/#installation),
and [`mixtools`](https://github.com/dsy109/mixtools?tab=readme-ov-file#installation)
for guidance on installing these packages into your R package library.

Once all three of those packages are installed, we can load them into 
our active R session environment:

```{r load_packages}
library(serocalculator)
library(tidyverse)
library(mixtools)
```

### Load data

Pathogen-specific sample datasets, noise parameters, and longitudinal antibody dynamics for **serocalculator** are available on the [Serocalculator Repository](https://osf.io/ne8pc/) on Open Science Framework (OSF). We will pull this data directly into our R environment.



#### Load and prepare longitudinal parameter data

We will first load the longitudinal curve parameters to set the antibody decay parameters. These parameters were modeled with Bayesian hierarchical models to fit two-phase power-function decay models to the longitudinal antibody responses among confirmed enteric fever cases. 


```{r curve, message=FALSE}
# Import longitudinal antibody parameters from OSF

curves <-
  "https://osf.io/download/u5gxh/" |> 
  load_sr_params()
```

#### Visualize curve parameters

We can graph the decay curves with an `autoplot()` method:

```{r}
# Visualize curve parameters with custom colors
curves |> autoplot() +
  scale_color_manual(values = c("India" = "orange2", "Nepal" = "#39558CFF")) + 
  geom_point(alpha = .8)
```


#### Load and prepare cross-sectional data 
Next, we load our sample cross-sectional data. 


```{r data, message = FALSE}
# Import cross-sectional data from OSF and rename required variables
xs_data <- load_pop_data(
  file_path = "https://osf.io/download/h5js4/",
  age = "Age",
  value = "result",
  id = "index_id",
  standardize = TRUE
)
```

#### Check formatting

We can check that `xs_data` has the correct formatting using the `check_pop_data()` function:

```{r, message = TRUE}
xs_data |> check_pop_data(verbose = TRUE)
```

#### Summarize antibody data

We can compute numerical summaries of our cross-sectional antibody data with a `summary()` method for `pop_data` objects:

```{r}
xs_data |> summary(strata = "country")
```


#### Visualize antibody data

Let's also take a look at how antibody responses change by age.

```{r plot-age}
# Plot antibody responses by age with custom colors
autoplot(object = xs_data, type = "age-scatter", strata = "country") +
  scale_color_manual(values = c("India" = "orange2", "Nepal" = "#39558CFF"))
```

As is clear from these data, the study in Nepal was performed in children, while the study in India was performed in adults, yet we can see that the values were higher on average and with less variation in Nepal.



### Compile noise parameters

Next, we must set conditions based on some assumptions about the data and errors that may need to be accounted for. This will differ based on background knowledge of the data. 


The biological noise, $\nu$ ("nu"), represents error from cross-reactivity to other antibodies. Measurement noise, $\varepsilon$ ("epsilon"), represents error from the laboratory testing process. 

*Formatting Specifications*: Noise parameter data should be a dataframe with one row for each antigen isotype and columns for each noise parameter below.


Column Name | Description
----------- | -----------
    y.low   | Lower limit of detection of the antibody assay
    nu      | Biologic noise
    y.high  | Upper limit of detection of the antibody assay
    eps     | Measurement noise
*Note that variable names are case-sensitive.*

```{r message=FALSE, warning=FALSE}
# Biologic noise calculation
# Note: There was an error in the SD calculation in the original paper.
# The correct approach is to use the sigma value directly from the mixture model,
# not sqrt(sigma). This vignette uses the corrected calculation.

set.seed(54321)

# For IgG: use data from children under 5 years
b_noise_IgG <- xs_data |>
  filter(!is.na(value), Age < 5, antigen_iso == "OT56kda_IgG") |>
  group_by(antigen_iso) |>
  group_modify(~{
    mixmod <- mixtools::normalmixEM(.x$value, k = 2, maxit = 1000)
    
    lower_k <- which.min(mixmod$mu)   # pick the lower-mean component
    lower_mu <- mixmod$mu[lower_k]
    lower_sd <- mixmod$sigma[lower_k] 
    
    tibble::tibble(
      percentile90 = qnorm(0.9, mean = lower_mu, sd = lower_sd)
    )
  }) |>
  ungroup()

# For IgM: use full population (no age restriction due to limited data in young children)
b_noise_IgM <- xs_data |>
  filter(!is.na(value), antigen_iso == "OT56kda_IgM") |>
  group_by(antigen_iso) |>
  group_modify(~{
    mixmod <- mixtools::normalmixEM(.x$value, k = 2, maxit = 1000)
    
    lower_k <- which.min(mixmod$mu)   # pick the lower-mean component
    lower_mu <- mixmod$mu[lower_k]
    lower_sd <- mixmod$sigma[lower_k] 
    
    tibble::tibble(
      percentile90 = qnorm(0.9, mean = lower_mu, sd = lower_sd)
    )
  }) |>
  ungroup()

# Combine the noise estimates
b_noise <- bind_rows(b_noise_IgG, b_noise_IgM)

# Define conditional parameters
noise <- data.frame(
  antigen_iso = c("OT56kda_IgG", "OT56kda_IgM"),
  nu = as.numeric(c(b_noise[1, 2], b_noise[2, 2])), # Biologic noise (nu)
  eps = c(0.2, 0.2), # Measurement noise (eps)
  y.low = c(0.2, 0.2), # low cutoff (llod)
  y.high = c(200, 200)
) |> # high cutoff (y.high)
  mutate(across(where(is.numeric), round, digits = 2))
```

The table below shows the noise parameters that will be used in the serocalculator function:

```{r}
# Display noise parameters table
knitr::kable(noise, 
             caption = "Noise parameters for scrub typhus seroincidence estimation",
             col.names = c("Antigen-Isotype", "Biological Noise (ν)", 
                          "Measurement Noise (ε)", "Lower Limit", "Upper Limit"))
```

## Estimate Seroincidence by study site
Now we are ready to begin estimating seroincidence. We will use `est.incidence.by` to calculate stratified seroincidence rates.


```{r estby}
# Using est.incidence.by (strata)

est <- est_seroincidence_by(
  strata = c("country"),
  pop_data = xs_data,
  sr_params = curves,
  noise_params = noise,
  antigen_isos = c("OT56kda_IgG"),
  num_cores = 8 # Allow for parallel processing to decrease run time
)

summary(est)
```

### Compare seroincidence rates between countries

We can use the `compare_seroincidence()` function to perform statistical comparisons between countries and generate a nicely formatted table with p-values:

```{r}
# Compare seroincidence rates between countries
comparison <- compare_seroincidence(est)

# Display comparison table
knitr::kable(comparison,
             digits = 4,
             caption = "Statistical comparison of seroincidence rates between countries")
```

### Summary table with seroincidence rates

```{r}
# Create a nicely formatted summary table
summary_table <- summary(est) |>
  mutate(
    `Incidence Rate (per person-year)` = sprintf("%.4f", incidence.rate),
    `95% CI` = sprintf("[%.4f, %.4f]", CI.lwr, CI.upr),
    `Standard Error` = sprintf("%.4f", SE)
  ) |>
  select(country, `Incidence Rate (per person-year)`, `95% CI`, `Standard Error`)

knitr::kable(summary_table,
             caption = "Scrub typhus seroincidence rates by country")
```


## Estimate Seroincidence by study site and age strata
Now we are ready to begin estimating seroincidence. We will use `est.incidence.by` to calculate stratified seroincidence rates.


```{r estby2}
# Using est.incidence.by (strata)

est2 <- est_seroincidence_by(
  strata = c("country", "ageQ"),
  pop_data = xs_data,
  sr_params = curves,
  noise_params = noise,
  antigen_isos = c("OT56kda_IgG"),
  num_cores = 8 # Allow for parallel processing to decrease run time
)

summary(est2)
```

### Compare seroincidence rates between age groups and countries

```{r}
# Compare all pairs of strata
comparison2 <- compare_seroincidence(est2)

# Display comparison table
knitr::kable(comparison2,
             digits = 4,
             caption = "Statistical comparisons of seroincidence rates between strata")
```







Let's visualize our seroincidence estimates by strata.


```{r}
# Plot seroincidence estimates

# Save summary(est) as a dataframe
estdf <- summary(est) |>
  mutate(ageQ = "Overall")

# Save summary(est2) as a dataframe
est2df <- summary(est2)


est_comb <- rbind(estdf, est2df)

# Create barplot (rescale incidence rate and CIs)
ggplot(est_comb, aes(y = ageQ, x = incidence.rate * 1000, fill = country)) +
  geom_bar(
    stat = "identity",
    position = position_dodge2(width = 0.8, preserve = "single")
  ) +
  geom_linerange(aes(xmin = CI.lwr * 1000, xmax = CI.upr * 1000),
                 position = position_dodge2(width = 0.8, preserve = "single")) +
  labs(title = "Scrub Typhus Seroincidence by Country",
       x = "Seroincidence rate per 1000 person-years",
       y = "Age Group") +
  theme_bw() +
  facet_wrap(~ country) +
  theme(axis.text.y = element_text(size = 11),
        axis.text.x = element_text(size = 11)) +
  scale_fill_manual(values = c("India" = "orange2", "Nepal" = "#39558CFF"))
```




## Acknowledgments
We gratefully acknowledge the study participants for their valuable time and interest in participating in these studies

## Funding
This work was supported by the National Institutes of Health Fogarty International Center (FIC) at [K01 TW012177] and the National Institute of Allergy and Infectious Diseases (NIAID) [R21 1AI176416] 

## References
