---
title: "Typhoid Seroincidence"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Typhoid Seroincidence}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
#Introduction

This vignette provides users with an example analysis using the *serocalculator* package. Users will be able to determine the seroincidence of typhoid fever in the sample population using existing longitudinal antibody dynamics from ______, and a cross-sectional serosurvey from _____. 

##References
(To be added)

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
#Sample Analysis
## ##Load serocalculator package
##Still in development as of 09/01/23
The first step in conducting this analysis is to load our necessary packages. Follow the installation instructions [add link] if you ahev not already installed *serocalculator*. 

```{r setup}

#library(devtools)
#install_github("UCD-SERG/serocalculator")
library(serocalculator)
library(tidyverse)
```

##Load data
###Load longitudinal parameter mcmc data and prepare for model
The next step is to load the longitudinal data modeled with Monte Carlo Markov Chain ____ (Add more here). 

These data include the following variables...

The code chunk below loads the data included in the *serocalculator* package. We then create two additional variables, *alpha* and *d*. *Alpha* is the ______ and *d* is the ______. Finally, we select only the variables needed for the analysis. 
```{r longdata}
c.hlye.IgG <- 
  fs::path_package(                          
  "extdata", 
  "dmcmc_hlyeigg_09.30.rds", 
  package = "serocalculator") |> 
 readRDS()%>%
  mutate(alpha = alpha*365.25, 
         d = r-1) %>%
  select(y1, alpha, d) 
```

##Load simulated data (lambda = .2) and prepare for model
The simulated data are assuming a force of infection (FOI, *lambda*) of 0.2. We have selected hlye and IgG as our target measures. From the original dataset, we rename our variables to ______. Finally, we once again limit the dataset to only the variables needed for the analysis. 
``` {r simdata}
library(fs) # filesystem utility functions
p.hlye.IgG  <- 
  fs::path_package(
    package = "serocalculator", 
    "extdata/simpophlyeigg.2.csv") %>%
  read_csv() %>%
  rename(
    y = y.smpl,
    a = a.smpl) %>% 
  select(y, a)
```


## Conditions based on how i simulated the data
Next, we must set conditions based on some assumptions and simulated data. (Add more here)
``` {r conditions}
cond.hlye.IgG <- data.frame(
  nu = 1.027239,             # B noise
  eps = 0.2,            # M noise
  y.low = 0.0,          # low cutoff
  y.high = 5e4); 
```


## Seroincidence estimation
Finally, we are ready to begin seroincidence estimation. We define our starting value as 0.5, which will also define our initial estimate for lambda (FOI). Then we set up values for the confidence interval. 

(Add explanation for each section below)
```{r seroinc}
start <- .05

lambda = start # initial estimate: starting value
log.lambda = log(lambda)
log.lmin=log(lambda/10)
log.lmax=log(10*lambda) 



objfunc <- function(llam){
  return(res <- fdev(llam, p.hlye.IgG, c.hlye.IgG, cond.hlye.IgG))
}


fit <- nlm(objfunc,log.lambda,
           hessian=TRUE,print.level=0,stepmax=(log.lmax-log.lmin)/4)


#lambda, lower, upper, LF min
log.lambda.est <- c(exp(fit$estimate),
                    exp(fit$estimate + qnorm(c(0.025))*sqrt(1/fit$hessian)),
                    exp(fit$estimate + qnorm(c(0.975))*sqrt(1/fit$hessian)),
                    fit$minimum)


log.lambda.est
```
In our simulated data, we found that the estimated seroincidence of typhoid is ______. 
